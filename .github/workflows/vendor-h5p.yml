name: Vendor H5P runtime into docs (robust, simple)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  vendor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Ensure docs directory
        run: mkdir -p docs

      - name: Fetch main.bundle.js
        shell: bash
        run: |
          set -e
          echo "Fetching main.bundle.js…"
          # Try jsDelivr tag 1.3.0
          if curl -fsSL "https://cdn.jsdelivr.net/gh/tunapanda/h5p-standalone@1.3.0/dist/main.bundle.js" -o docs/main.bundle.js; then
            echo "Got main.bundle.js from jsDelivr 1.3.0"
          # Try jsDelivr master
          elif curl -fsSL "https://cdn.jsdelivr.net/gh/tunapanda/h5p-standalone@master/dist/main.bundle.js" -o docs/main.bundle.js; then
            echo "Got main.bundle.js from jsDelivr master"
          # Try unpkg latest
          elif curl -fsSL "https://unpkg.com/h5p-standalone@latest/dist/main.bundle.js" -o docs/main.bundle.js; then
            echo "Got main.bundle.js from unpkg latest"
          else
            echo "ERROR: Could not fetch main.bundle.js from any mirror"
            exit 1
          fi

      - name: Fetch frame.bundle.js
        shell: bash
        run: |
          set -e
          echo "Fetching frame.bundle.js…"
          if curl -fsSL "https://cdn.jsdelivr.net/gh/tunapanda/h5p-standalone@1.3.0/dist/frame.bundle.js" -o docs/frame.bundle.js; then
            echo "Got frame.bundle.js from jsDelivr 1.3.0"
          elif curl -fsSL "https://cdn.jsdelivr.net/gh/tunapanda/h5p-standalone@master/dist/frame.bundle.js" -o docs/frame.bundle.js; then
            echo "Got frame.bundle.js from jsDelivr master"
          elif curl -fsSL "https://unpkg.com/h5p-standalone@latest/dist/frame.bundle.js" -o docs/frame.bundle.js; then
            echo "Got frame.bundle.js from unpkg latest"
          else
            echo "ERROR: Could not fetch frame.bundle.js from any mirror"
            exit 1
          fi

      - name: Fetch h5p.css
        shell: bash
        run: |
          set -e
          echo "Fetching h5p.css…"
          if curl -fsSL "https://cdn.jsdelivr.net/gh/tunapanda/h5p-standalone@1.3.0/dist/styles/h5p.css" -o docs/h5p.css; then
            echo "Got h5p.css from jsDelivr 1.3.0"
          elif curl -fsSL "https://cdn.jsdelivr.net/gh/tunapanda/h5p-standalone@master/dist/styles/h5p.css" -o docs/h5p.css; then
            echo "Got h5p.css from jsDelivr master"
          elif curl -fsSL "https://unpkg.com/h5p-standalone@latest/dist/styles/h5p.css" -o docs/h5p.css; then
            echo "Got h5p.css from unpkg latest"
          else
            echo "ERROR: Could not fetch h5p.css from any mirror"
            exit 1
          fi

      - name: Commit files to main
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/main.bundle.js docs/frame.bundle.js docs/h5p.css
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Vendor h5p-standalone dist into docs (automated)"
            git push origin main
          fi

      - name: Show docs listing
        run: ls -lh docs
