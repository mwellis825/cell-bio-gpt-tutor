name: Pages
on:
  push: { branches: [ "main" ] }
  workflow_dispatch:
permissions:
  contents: read
  pages: write
  id-token: write
concurrency: { group: "pages", cancel-in-progress: true }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure docs/
        run: mkdir -p docs
      - name: Fetch h5p-standalone dist (tries multiple versions)
        run: |
          set -euo pipefail
          VERSIONS=("1.4.0" "1.3.1" "latest")
          ok=""
          for V in "${VERSIONS[@]}"; do
            echo "Trying npm ${V}â€¦"
            curl -fsSL "https://registry.npmjs.org/h5p-standalone/-/h5p-standalone-${V}.tgz" -o h5p.tgz && ok="$V" && break || true
          done
          if [ -z "$ok" ]; then echo "Failed to fetch from npm"; exit 1; fi
          tar -xzf h5p.tgz
          ls -la package/dist
          cp package/dist/main.bundle.js docs/main.bundle.js
          cp package/dist/frame.bundle.js docs/frame.bundle.js
          if [ -f package/dist/styles/h5p.css ]; then
            cp package/dist/styles/h5p.css docs/h5p.css
          else
            cp package/dist/h5p.css docs/h5p.css
          fi
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with: { path: docs }
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: { name: github-pages, url: ${{ steps.deployment.outputs.page_url }} }
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
