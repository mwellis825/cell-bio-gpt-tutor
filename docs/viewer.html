<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- CSP: allow local, blob:, data:, and https (CDN + your .h5p host) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: blob:;
                 script-src  'self' https: 'unsafe-inline' 'unsafe-eval' data: blob:;
                 style-src   'self' https: 'unsafe-inline' data: blob:;
                 img-src     'self' https: data: blob:;
                 connect-src 'self' https: data: blob:;
                 worker-src  'self' blob:;">

  <!-- Core H5P CSS you put in /docs (from h5p-standalone dist) -->
  <link rel="stylesheet" href="./h5p.css" />
  <style>
    html, body { height:100%; margin:0; background:#fff; }
    #app { min-height:100vh; }
    .err { color:#b00; padding:1rem; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  </style>

  <!-- Define H5PIntegration BEFORE any bundles -->
  <script>
    window.H5PIntegration = {
      baseUrl: window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, ''),
      url: window.location.href,
      hubIsEnabled: false,
      saveFreq: false,
      ajax: { setFinished: "", contentUserData: "" },
      siteUrl: window.location.origin,
      l10n: { H5P: { fullscreen: "Fullscreen", exitFullscreen: "Exit fullscreen" } },
      libraryUrl: "./",
      postUserStatistics: false,
      disableHub: true,
      core: { scripts: [], styles: [] },
      loadedJs: [], loadedCss: [],
      contents: {}
    };
  </script>

  <script>
    function qp(name) {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => { console.log("Loaded", src); resolve(); };
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }
    async function boot() {
      const app = document.getElementById('app');
      const src = qp('src'); // <-- absolute/public URL to the .h5p file
      if (!src) {
        app.innerHTML = '<p class="err">No H5P source. Use <code>?src=&lt;url-to-your.h5p&gt;</code>.</p>';
        return;
      }

      // 1) Try LOCAL bundles (from /docs)
      try {
        await loadScript("./main.bundle.js");
        await loadScript("./frame.bundle.js");
      } catch (e) {
        console.warn(e.message);
      }

      // 2) If not ready, fall back to CDN (known-good version)
      if (!(window.H5PStandalone && typeof window.H5PStandalone.display === 'function')) {
        console.warn("Local bundles did not expose H5PStandalone; loading CDN fallback…");
        try {
          await loadScript("https://cdn.jsdelivr.net/npm/h5p-standalone@1.3.0/dist/main.bundle.js");
          await loadScript("https://cdn.jsdelivr.net/npm/h5p-standalone@1.3.0/dist/frame.bundle.js");
        } catch (e) {
          app.innerHTML = '<p class="err">' + e.message + '</p>';
          return;
        }
      }

      // 3) Wait for readiness and display the .h5p from ?src=
      let tries = 0;
      (function waitReady(){
        tries++;
        if (window.H5PStandalone && typeof window.H5PStandalone.display === 'function') {
          console.log("H5PStandalone ready; rendering content…");
          try {
            window.H5PStandalone.display('#app', { h5pContent: src });
          } catch (e) {
            app.innerHTML = '<p class="err">Could not initialize H5P: ' +
              (e && e.message ? e.message : e) + '</p>';
          }
        } else if (tries < 240) {
          setTimeout(waitReady, 50);
        } else {
          app.innerHTML = '<p class="err">H5P API not ready. Verify CSP and bundles.</p>';
        }
      })();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
