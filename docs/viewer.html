<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>H5P Viewer (robust export detection)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./h5p.css" />
  <style>
    html,body{margin:0;height:100%;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{min-height:100vh}
    .err{color:#b00;padding:1rem;line-height:1.5}
    .hint{padding:.75rem 1rem;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:.5rem;margin:1rem}
    code{background:#f3f4f6;padding:0 .25rem;border-radius:.25rem}
    pre{white-space:pre-wrap;word-break:break-word;background:#f9fafb;border:1px solid #e5e7eb;border-radius:.5rem;padding:.75rem;margin:1rem}
  </style>

  <script>
    // Minimal H5PIntegration must exist before frame.bundle.js
    window.H5PIntegration = {
      baseUrl: location.origin + location.pathname.replace(/\/[^\/]*$/, ''),
      url: location.href,
      siteUrl: location.origin,
      hubIsEnabled: false,
      disableHub: true,
      postUserStatistics: false,
      saveFreq: false,
      l10n: { H5P: { fullscreen: "Fullscreen", exitFullscreen: "Exit fullscreen" } },
      ajax: { setFinished: "", contentUserData: "" },
      libraryUrl: "./",
      core: { scripts: [], styles: [] },
      loadedJs: [], loadedCss: [],
      contents: {}
    };

    // AMD/CJS shims + capture
    (function installCaptureShims(){
      window.__H5P_EXPORT__ = undefined;
      const cjsModule  = { exports: {} };
      const cjsExports = cjsModule.exports;

      Object.defineProperty(window, 'module',  { configurable: true, writable: true, value: cjsModule  });
      Object.defineProperty(window, 'exports', { configurable: true, writable: true, value: cjsExports });

      function amdDefine(name, deps, factory){
        if (typeof name === 'function') { factory = name; deps = []; }
        else if (Array.isArray(name))   { factory = deps; deps = name; }
        else if (typeof deps === 'function') { factory = deps; deps = []; }
        let resolved = [];
        if (Array.isArray(deps)) {
          resolved = deps.map(d => {
            if (d === 'exports') return cjsExports;
            if (d === 'module')  return cjsModule;
            if (d === 'require') return function(){};
            if (d === 'h5p-standalone' || d === 'H5PStandalone')
              return window.H5PStandalone || window['h5p-standalone'] || window.__H5P_EXPORT__;
            return {};
          });
        }
        let out = (typeof factory === 'function') ? factory.apply(null, resolved) : factory;
        if (out && (typeof out === 'object' || typeof out === 'function')) window.__H5P_EXPORT__ = out;
        return out;
      }
      amdDefine.amd = {};
      Object.defineProperty(window, 'define',  { configurable: true, writable: true, value: amdDefine });
      Object.defineProperty(window, 'require', { configurable: true, writable: true, value: function(){ return {}; } });

      window.__finalizeH5PStandalone__ = function(){
        const candidate =
          window.__H5P_EXPORT__ ||
          (window.module && window.module.exports) ||
          window.H5PStandalone ||
          window['h5p-standalone'];
        if (candidate && (typeof candidate === 'object' || typeof candidate === 'function')) {
          window.H5PStandalone = candidate;
          window['h5p-standalone'] = candidate;
        }
      };
    })();

    function qp(n){ const u=new URL(location.href); return u.searchParams.get(n); }
  </script>

  <!-- Load in order -->
  <script src="./main.bundle.js"></script>
  <script src="./frame.bundle.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    (function boot(){
      const app = document.getElementById('app');
      const src = qp('src'); // URL or data:application/zip;base64,...
      if (!src) {
        app.innerHTML = '<div class="hint">No H5P source. Use <code>?src=&lt;url-to-your.h5p&gt;</code> (or a data: URL).</div>';
        return;
      }

      if (typeof window.__finalizeH5PStandalone__ === 'function') {
        try { window.__finalizeH5PStandalone__(); } catch {}
      }

      let tries = 0;
      (function waitReady(){
        tries++;
        const rawHS =
          window.H5PStandalone ||
          window['h5p-standalone'] ||
          window.__H5P_EXPORT__ ||
          (window.module && window.module.exports);

        // Some builds export { default: { display() {â€¦} } }
        const HS = rawHS && (rawHS.display ? rawHS : (rawHS.default && rawHS.default.display ? rawHS.default : null));

        if (HS && typeof HS.display === 'function') {
          console.log('Resolved H5P API object =', HS === rawHS ? 'global export' : 'export.default');
          try { HS.display('#app', { h5pContent: src }); }
          catch(e){
            console.error(e);
            app.innerHTML = '<p class="err">Could not initialize H5P: '+(e?.message||e)+'</p>';
          }
        } else if (tries < 240) {
          setTimeout(waitReady, 50); // ~12s total
        } else {
          console.log('Debug types:',
            'H5PStandalone =', typeof window.H5PStandalone,
            '| h5p-standalone =', typeof window['h5p-standalone'],
            '| __H5P_EXPORT__ =', typeof window.__H5P_EXPORT__,
            '| module.exports =', typeof (window.module && window.module.exports),
            '| rawHS keys =', rawHS && Object.keys(rawHS || {}));
          app.innerHTML = '<p class="err">H5P API not ready. Export present but no <code>display()</code>. This usually means your bundles are not the <em>standalone dist</em> from <code>h5p-standalone@1.3.0/dist</code> or they are a variant that requires <code>export.default</code>. This viewer now checks <code>export.default.display</code> too.</p>';
        }
      })();
    })();
  </script>
</body>
</html>
