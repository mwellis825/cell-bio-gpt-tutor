<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>H5P Viewer (debug eval)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{min-height:100vh}
    .err{color:#b00;padding:1rem;line-height:1.5}
    .hint{padding:.75rem 1rem;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:.5rem;margin:1rem}
    code{background:#f3f4f6;padding:0 .25rem;border-radius:.25rem}
    pre{white-space:pre-wrap;word-break:break-word;background:#f9fafb;border:1px solid #e5e7eb;border-radius:.5rem;padding:.75rem;margin:1rem}
  </style>
  <script>
    // Loud error reporting
    window.addEventListener('error', e => {
      console.error('window.onerror:', e.error || e.message || e);
      const app = document.getElementById('app');
      app.innerHTML = '<div class="err">Runtime error: '+(e.message||e)+'</div>';
    });
    window.addEventListener('unhandledrejection', e => {
      console.error('unhandledrejection:', e.reason || e);
      const app = document.getElementById('app');
      app.innerHTML = '<div class="err">Unhandled promise rejection: '+(e.reason?.message||e)+'</div>';
    });

    function qp(n){ const u=new URL(location.href); return u.searchParams.get(n); }

    async function fetchText(url) {
      const r = await fetch(url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('Fetch failed: ' + url + ' (' + r.status + ')');
      const ct = r.headers.get('content-type') || '';
      console.log('Fetched', url, 'content-type=', ct);
      const txt = await r.text();
      console.log('First 80 chars of', url, '=>', JSON.stringify(txt.slice(0,80)));
      console.log('Length of', url, '=>', txt.length);
      return txt;
    }

    function evalGlobal(js, label) {
      try {
        // Evaluate in global scope
        (0, eval)(js);
        console.log('Eval OK ('+label+')');
        return true;
      } catch (e) {
        console.error('Eval ERROR ('+label+'):', e);
        const app = document.getElementById('app');
        app.insertAdjacentHTML('beforeend', '<pre><strong>Eval error in '+label+':</strong>\n'+(e.stack||e)+'</pre>');
        return false;
      }
    }

    async function boot(){
      const app = document.getElementById('app');
      const src = qp('src');
      if (!src) {
        app.innerHTML = '<div class="hint">No H5P source. Use <code>?src=&lt;url-to-your.h5p&gt;</code> or a <code>data:application/zip;base64,...</code> URL.</div>';
        return;
      }

      // 1) Fetch local bundles as text and eval them
      let mainJs, frameJs;
      try {
        mainJs = await fetchText('./main.bundle.js');
        frameJs = await fetchText('./frame.bundle.js');
      } catch (e) {
        app.innerHTML = '<div class="err">'+(e.message||e)+'</div>';
        return;
      }

      if (!evalGlobal(mainJs, 'main.bundle.js')) return;
      if (!evalGlobal(frameJs, 'frame.bundle.js')) return;

      console.log('typeof H5PStandalone =', typeof window.H5PStandalone);
      console.log('typeof window["h5p-standalone"] =', typeof window['h5p-standalone']);

      let tries = 0;
      (function waitReady(){
        tries++;
        const HS = window.H5PStandalone || window['h5p-standalone'];
        if (HS && typeof HS.display === 'function') {
          console.log('H5P detected; rendering â€¦');
          try { HS.display('#app', { h5pContent: src }); }
          catch(e){ app.innerHTML = '<p class="err">Could not initialize H5P: '+(e?.message||e)+'</p>'; }
        } else if (tries < 240) { setTimeout(waitReady, 50); }
        else {
          app.innerHTML = '<p class="err">H5P API not ready. Both globals are undefined after eval; see console output and any eval errors above.</p>';
        }
      })();
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
