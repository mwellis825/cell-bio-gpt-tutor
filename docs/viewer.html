<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>H5P Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- No CSP while debugging to rule it out; add later if you like -->
  <link rel="stylesheet" href="./h5p.css" />
  <style>
    html, body { margin:0; height:100%; background:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    #app { min-height:100vh; }
    .err { color:#b00; padding:1rem; }
    .hint { padding:.75rem 1rem; background:#f6f8fa; border:1px solid #e5e7eb; border-radius:.5rem; margin:1rem; }
    code { background:#f3f4f6; padding:0 .25rem; border-radius:.25rem; }
  </style>
  <script>
    function qp(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src = src;            // <-- single, fixed URL (no extra query)
        s.onload = () => { console.log('Loaded', src); resolve(); };
        s.onerror = () => reject(new Error('Failed to load: ' + src));
        document.head.appendChild(s);
      });
    }
    async function boot(){
      const app = document.getElementById('app');
      const src = qp('src'); // URL or data:application/zip;base64,...
      if(!src){
        app.innerHTML = '<div class="hint">No H5P source. Use <code>?src=&lt;url-to-your.h5p&gt;</code> (or a data: URL).</div>';
        return;
      }
      try {
        await loadScript('./main.bundle.js');
        await loadScript('./frame.bundle.js');
      } catch(e) { app.innerHTML = '<p class="err">'+e.message+'</p>'; return; }

      // Accept either global name the bundle may expose
      const HS = window.H5PStandalone || window['h5p-standalone'];
      console.log('typeof H5PStandalone =', typeof window.H5PStandalone);
      console.log('typeof window["h5p-standalone"] =', typeof window['h5p-standalone']);

      let tries = 0;
      (function waitReady(){
        tries++;
        const H = window.H5PStandalone || window['h5p-standalone'];
        if (H && typeof H.display === 'function') {
          try { H.display('#app', { h5pContent: src }); }
          catch(e){ app.innerHTML = '<p class="err">Could not initialize H5P: '+(e?.message||e)+'</p>'; }
        } else if (tries < 240) { setTimeout(waitReady, 50); }
        else {
          app.innerHTML = '<p class="err">H5P API not ready. If both globals are "undefined", your JS files arenâ€™t the h5p-standalone runtime or failed to execute (check Console/Network).</p>';
        }
      })();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
